<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Scoreboard - Modern Aggressive</title>
    <style>
        /* --- CSS STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Roboto', sans-serif; outline: none; }
        
        body {
            background-color: #121212; /* Darker background */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* --- OBS OVERLAY MODE --- */
        body.overlay-mode {
            background-color: transparent;
            overflow: hidden;
            justify-content: flex-end;
            padding: 0;
        }
        body.overlay-mode .control-panel { display: none !important; }
        body.overlay-mode .broadcast-container {
            margin: 0; border: none; height: 100vh;
            background-color: transparent;
        }

        /* --- BROADCAST CONTAINER --- */
        .broadcast-container {
            width: 100%;
            height: 400px;
            background-color: #00ff00; /* CHROMA KEY GREEN */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 30px;
            margin-bottom: 10px;
            border-bottom: 4px solid #333;
            position: relative;
            overflow: hidden;
        }

        /* --- ANIMATION CONTAINER --- */
        .event-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            pointer-events: none;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* --- STYLE: FOUR (Cyber Swipe) --- */
        .style-four {
            display: flex;
            justify-content: center;
            align-items: center;
            width: auto;
            padding: 10px 80px;
            background: rgba(0, 0, 0, 0.85);
            border: 4px solid #fff;
            border-top: none;
            border-bottom: none;
            color: #fff;
            font-size: 7rem;
            font-weight: 900;
            font-style: italic;
            text-transform: uppercase;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 40px #0088cc;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            will-change: transform, opacity; /* OPTIMIZATION FIX */
            animation: neonSlam 2.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* --- STYLE: SIX (Neon Slam) --- */
        .style-six {
            display: flex;
            justify-content: center;
            align-items: center;
            width: auto;
            padding: 10px 80px;
            background: rgba(0, 0, 0, 0.85);
            border: 4px solid #fff;
            border-top: none;
            border-bottom: none;
            color: #fff;
            font-size: 7rem;
            font-weight: 900;
            font-style: italic;
            text-transform: uppercase;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 40px #0088cc;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            will-change: transform, opacity; /* OPTIMIZATION FIX */
            animation: neonSlam 2.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes neonSlam {
            0% { transform: translate(-50%, -50%) scale(5); opacity: 0; letter-spacing: 50px; }
            10% { transform: translate(-50%, -50%) scale(1); opacity: 1; letter-spacing: 10px; }
            15% { text-shadow: none; opacity: 0.8; }
            20% { text-shadow: 0 0 20px #0ff; opacity: 1; }
            25% { text-shadow: none; opacity: 0.9; }
            30% { text-shadow: 0 0 20px #0ff; opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }

        /* --- STYLE: WICKET (Red Alert) --- */
        .style-wicket {
            display: flex;
            background: #d50000;
            color: white;
            padding: 20px 100px;
            font-size: 6rem;
            font-weight: 900;
            text-transform: uppercase;
            border: 5px solid white;
            box-shadow: 0 0 50px rgba(213, 0, 0, 0.8);
            will-change: transform, opacity; /* OPTIMIZATION FIX */
            animation: redAlert 3s forwards;
            letter-spacing: 5px;
        }

        @keyframes redAlert {
            0% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
            10% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            12% { transform: translate(-52%, -48%) scale(1); }
            14% { transform: translate(-48%, -52%) scale(1); }
            16% { transform: translate(-52%, -50%) scale(1); }
            18% { transform: translate(-50%, -50%) scale(1); }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0;}
        }

        /* --- STYLE: WIN (Neon Victory) --- */
        .style-win {
            display: flex;
            background: transparent;
            color: #ffffff;
            font-size: 6rem;
            font-weight: 900;
            text-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff, 0 0 40px #aaaaaa;
            border: 4px solid #ffffff;
            padding: 20px 60px;
            box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.8), 0 0 30px rgba(255, 255, 255, 0.8);
            will-change: transform, opacity; /* OPTIMIZATION FIX */
            animation: neonSlam 4s ease-out forwards;
        }

        /* --- SCOREBOARD STYLES --- */
        .info-bar {
            background: rgba(0, 0, 0, 0.9); color: white;
            padding: 6px 20px; border-radius: 4px; /* Square edges */
            margin-bottom: 10px; display: flex; gap: 20px;
            font-weight: bold; font-size: 0.8em; text-transform: uppercase;
            border: 1px solid #444; border-left: 4px solid #00e5ff; /* Cyan accent */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease; transform: translateY(20px); opacity: 0;
        }
        .info-bar.visible { transform: translateY(0); opacity: 1; }
        .info-item { display: flex; align-items: center; gap: 5px; }
        .label-gold { color: #ffc107; }
        .label-blue { color: #4fc3f7; }
        .label-grey { color: #bbb; }

        /* --- SPECIAL LABELS (FH & PP) --- */
        .label-fh {
            color: #ff00de; font-weight: 900; text-shadow: 0 0 5px #ff00de;
            display: none; margin-right: 15px; animation: flash 1s infinite;
        }
        .label-fh.visible { display: block; }
        
        .label-pp {
            color: #ff9100; font-weight: 900; text-shadow: 0 0 5px #ff9100;
            display: none; margin-right: 15px; animation: pulsePP 2s infinite;
        }
        .label-pp.visible { display: block; }

        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        @keyframes pulsePP { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        .scoreboard {
            width: 100%; height: 90px;
            background: linear-gradient(to right, #000 0%, #222 50%, #000 100%);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8); position: relative; padding: 0 15px; 
            border-top: 2px solid #444; border-bottom: 2px solid #444;
        }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .team-logo { width: 70px; height: 70px; border-radius: 5px; background: white; overflow: hidden; z-index: 2; display: flex; align-items: center; justify-content: center; border: 2px solid #555; }
        .team-logo img { width: 100%; height: 100%; object-fit: unset; }
        
        .panel-batsmen { flex: 1; padding-left: 20px; display: flex; flex-direction: column; gap: 4px; z-index: 5; }
        .batsman-row { display: flex; justify-content: space-between; width: 85%; color: #ddd; font-weight: 700; font-size: 1.1rem; }
        .batsman-name { text-transform: uppercase; display: flex; align-items: center; }
        .striker-indicator { color: #00e5ff; margin-right: 8px; font-size: 1rem; visibility: hidden; text-shadow: 0 0 5px #00e5ff; }
        .striker-indicator.active { visibility: visible; }
        
        /* Modern Center Panel */
        .panel-center {
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            color: white; width: 400px; height: 110%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: skewX(-10deg);
            border: 2px solid #333; box-shadow: 0 0 15px rgba(0,0,0,0.8); z-index: 10;
        }
        .score-row { display: flex; align-items: center; justify-content: center; width: 100%; transform: skewX(10deg); }
        .match-teams { font-size: 1.2rem; font-weight: 500; color: #88aadd; margin-right: 15px; text-transform: uppercase; letter-spacing: 1px;}
        .main-score { color: #fff; padding: 0 10px; font-size: 1.8rem; font-weight: 800; min-width: 100px; text-align: center; text-shadow: 0 2px 4px black; }
        .overs-box { background: #333; padding: 2px 10px; border-radius: 2px; text-align: center; min-width: 60px; margin-left: 10px; }
        .overs-label { font-size: 0.6rem; display: block; opacity: 0.8; }
        .overs-val { font-size: 1rem; font-weight: 600; color: #ffc107; }
        .over-complete-msg {
            position: absolute; bottom: -25px; background: #ff9800; color: black; font-size: 0.8rem; padding: 2px 10px; font-weight: bold; display: none; transform: skewX(10deg);
        }
        
        .panel-bowler { flex: 1; padding-right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; z-index: 5; }
        .bowler-header { display: flex; justify-content: space-between; width: 90%; color: #ddd; font-weight: 700; font-size: 1.1rem; text-transform: uppercase; }
        .over-history { display: flex; gap: 6px; min-height: 30px; align-items: center; }
        
        .ball { width: 28px; height: 28px; border-radius: 4px; background: #333; border: 1px solid #555; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85rem; color: #ddd; }
        .ball.four { background-color: #00e5ff; color: black; border: none; box-shadow: 0 0 5px #00e5ff; }
        .ball.six { background-color: #1a237e; color: white; border: 1px solid #00e5ff; }
        .ball.wicket { background-color: #d50000; color: white; border: none; }
        .ball.wide { background-color: #5d4037; color: white; border: none; font-size: 0.5rem;}
        .ball.nb { background-color: #e65100; color: white; border: none; font-size: 0.5rem;}

        /* --- CONTROL PANEL --- */
        .control-panel { 
            background: #222; width: 95%; max-width: 900px; 
            padding: 8px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            display: flex; gap: 8px; color: #ddd; font-size: 12px; align-items: flex-start;
        }
        .control-column { background: #333; padding: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 6px; }
        .col-setup { flex: 1; }
        .col-players { flex: 1.2; }
        .col-scoring { flex: 1.5; }

        h3 { font-size: 11px; color: #88aadd; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .input-row { display: flex; align-items: center; justify-content: space-between; gap: 5px; margin-bottom: 2px; }
        .input-row label { color: #aaa; font-size: 10px; flex: 0 0 50px; }
        .input-row input[type="text"], .input-row input[type="number"] {
            background: #1a1a1a; border: 1px solid #444; color: white;
            padding: 2px 5px; font-size: 11px; border-radius: 3px; flex: 1; height: 22px;
        }
        
        .score-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        button { border: none; border-radius: 4px; font-weight: bold; font-size: 12px; cursor: pointer; padding: 8px 0; color: white; transition: all 0.1s; }
        button:hover { filter: brightness(1.2); }
        button:active { transform: scale(0.98); }

        .btn-0, .btn-1, .btn-2, .btn-3 { background: #555; }
        .btn-4 { background: #0088cc; }
        .btn-6 { background: #002f6c; }
        .btn-w { background: #d91e5b; }
        .btn-wd { background: #795548; }
        .btn-nb { background: #e65100; }
        .btn-fh { background: #ff00de; }
        
        .actions-row { display: flex; gap: 4px; margin-top: 4px; }
        .btn-act { font-size: 10px; padding: 5px; flex: 1; background: #444; }
        .btn-swap { background: #1976D2; }
        .btn-undo { background: #ef5350; }
        .btn-end { background: #673AB7; }
        .btn-reset { background: #d32f2f; }

        #new-over-container { display: none; margin-top: 5px; }
        .btn-next-over { background: #388E3C; width: 100%; padding: 5px; font-size: 11px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* --- STYLING FOR DETAILS BOXES --- */
        .styled-details {
            background: #252525;
            border: 1px solid #444;
            border-radius: 4px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        .styled-details summary {
            padding: 6px 10px;
            font-size: 10px;
            color: #aaa;
            cursor: pointer;
            user-select: none;
            background: #333;
            display: flex; align-items: center; justify-content: space-between;
        }
        .styled-details summary:hover { color: #fff; background: #3a3a3a; }
        .styled-details summary::after { content: "▼"; font-size: 8px; }
        .styled-details[open] summary::after { content: "▲"; }
        
        .setup-content { padding: 8px; display: flex; flex-direction: column; gap: 8px; }
        .team-block { border-top: 1px solid #3a3a3a; padding-top: 5px; }
        .team-header { font-size: 9px; color: #88aadd; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; }
        .flex-row { display: flex; gap: 4px; align-items: center; }
        
        .input-group-styled { flex: 1; display: flex; flex-direction: column; }
        .input-group-styled label { font-size: 9px; color: #888; margin-bottom: 2px; }
        .input-group-styled input { 
            background: #111; border: 1px solid #555; color: white; 
            padding: 3px; font-size: 11px; border-radius: 3px; width: 100%;
        }
        .input-group-styled input:focus { border-color: #2196F3; }

        input[type="color"] {
            -webkit-appearance: none; border: none; width: 25px; height: 24px; 
            padding: 0; background: none; cursor: pointer; border-radius: 3px; overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #555; border-radius: 3px; }

        .btn-upload-styled {
            background: #444; color: #ccc; border: 1px solid #555;
            font-size: 10px; text-align: center; padding: 4px; 
            border-radius: 3px; cursor: pointer; margin-top: 4px; display: block;
        }
        .btn-upload-styled:hover { background: #555; color: white; }

        /* MANUAL EDIT SPECIFIC */
        .manual-inputs {
            display: flex; align-items: flex-end; justify-content: space-between;
            padding: 8px; gap: 4px;
        }
        .manual-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .manual-group label { font-size: 9px; color: #888; margin-bottom: 3px; font-weight: bold; }
        .manual-group input {
            width: 100%; text-align: center;
            background: #111; border: 1px solid #555;
            color: #fff; padding: 4px 0; border-radius: 3px;
            font-weight: bold; font-size: 11px;
        }
        .manual-group input:focus { border-color: #f57c00; background: #000; }
        
        .btn-set-manual {
            background: #f57c00; color: white; border: none; border-radius: 3px;
            cursor: pointer; font-weight: bold; font-size: 11px;
            padding: 0 10px; height: 26px; 
            margin-left: 4px; transition: background 0.2s;
        }
        .btn-set-manual:hover { background: #ef6c00; }

        @media (max-width: 800px) {
            .control-panel { flex-direction: column; }
            .control-column { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="broadcast-container">
        <div id="anim-overlay" class="event-overlay"></div>

        <div id="info-bar" class="info-bar">
            <div id="fh-label" class="label-fh">FREE HIT</div>
            <div id="pp-label" class="label-pp">POWERPLAY</div>
            
            <div class="info-item"><span class="label-grey">CRR:</span><span id="crr-display">0.00</span></div>
            <div id="target-wrapper" style="display:flex; gap:20px; border-left: 1px solid #555; padding-left:20px;">
                <div class="info-item"><span class="label-gold">TARGET:</span><span id="target-display">0</span></div>
                <div class="info-item"><span class="label-blue" id="equation-display">NEED 0 OFF 0</span></div>
            </div>
        </div>

        <div class="scoreboard" id="scoreboard-el">
            <div class="team-logo"><img id="img-left" src="https://cdn-icons-png.flaticon.com/512/16/16480.png"></div>

            <div class="panel-batsmen">
                <div class="batsman-row">
                    <div class="batsman-name"><span id="bat1-indicator" class="striker-indicator active">▶</span> <span id="bat1-name">OPENER 1</span></div>
                    <div class="batsman-score"><span id="bat1-runs">0</span> (<span id="bat1-balls">0</span>)</div>
                </div>
                <div class="batsman-row">
                    <div class="batsman-name"><span id="bat2-indicator" class="striker-indicator">▶</span> <span id="bat2-name">OPENER 2</span></div>
                    <div class="batsman-score"><span id="bat2-runs">0</span> (<span id="bat2-balls">0</span>)</div>
                </div>
            </div>

            <div class="panel-center">
                <div class="score-row">
                    <div class="match-teams" id="match-teams-display"> <span style="font-size:0.8em;color:#ccc">v</span> </div>
                    <div class="main-score"><span id="total-runs">0</span>/<span id="total-wickets">0</span></div>
                    <div class="overs-box"><span class="overs-label">OVERS</span><span class="overs-val" id="overs-display">0.0</span></div>
                </div>
                <div class="over-complete-msg" id="over-msg">OVER COMPLETE</div>
            </div>

            <div class="panel-bowler">
                <div class="bowler-header">
                    <div class="bowler-name" id="bowler-name">BOWLER</div>
                    <div class="bowler-figs"><span id="bowler-runs">0</span>-<span id="bowler-wickets">0</span> &nbsp; <span id="bowler-overs">0.0</span></div>
                </div>
                <div class="over-history" id="ball-history"></div>
            </div>

            <div class="team-logo"><img id="img-right" src="https://cdn-icons-png.flaticon.com/512/16/16480.png"></div>
        </div>
    </div>

    <div class="control-panel">
        <div class="control-column col-setup">
            <details class="styled-details">
                <summary>⚙ Match Setup</summary>
                <div class="setup-content">
                    <div class="flex-row">
                        <div class="input-group-styled">
                            <label>Total Overs</label>
                            <input type="number" id="match-overs" value="5" onchange="syncState()">
                        </div>
                        <div class="input-group-styled">
                            <label>Powerplay (e.g. 1-6)</label>
                            <input type="text" id="match-pp" value="1-6" onchange="syncState()" placeholder="1-6">
                        </div>
                    </div>

                    <div class="team-block">
                        <div class="team-header">Home Team</div>
                        <div class="flex-row">
                            <div class="input-group-styled">
                                <input type="text" id="set-team1-name" placeholder="Team Name" oninput="syncState()">
                            </div>
                            <input type="color" id="set-team1-color" value="#ffffff" oninput="syncState()" title="Team Color">
                        </div>
                        
                        <div style="margin-top:5px; border:1px dashed #555; padding:4px; border-radius:4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                                <label style="font-size:9px; color:#aaa;">Logo File (Must be in same folder)</label>
                                <label for="file-up-1" style="cursor:pointer; background:#444; color:#fff; font-size:9px; padding:2px 6px; border-radius:2px;">Browse...</label>
                                <input type="file" id="file-up-1" accept="image/*" style="display:none;" onchange="extractFileName(1)">
                            </div>
                            <input type="text" id="set-team1-logo" placeholder="e.g. logo1.png" oninput="syncState()" style="width:100%; background:#000; border:none; color:#0f0; font-size:10px;">
                        </div>
                    </div>

                    <div class="team-block">
                        <div class="team-header">Away Team</div>
                        <div class="flex-row">
                            <div class="input-group-styled">
                                <input type="text" id="set-team2-name" placeholder="Team Name" oninput="syncState()">
                            </div>
                            <input type="color" id="set-team2-color" value="#ffffff" oninput="syncState()" title="Team Color">
                        </div>

                        <div style="margin-top:5px; border:1px dashed #555; padding:4px; border-radius:4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                                <label style="font-size:9px; color:#aaa;">Logo File (Must be in same folder)</label>
                                <label for="file-up-2" style="cursor:pointer; background:#444; color:#fff; font-size:9px; padding:2px 6px; border-radius:2px;">Browse...</label>
                                <input type="file" id="file-up-2" accept="image/*" style="display:none;" onchange="extractFileName(2)">
                            </div>
                            <input type="text" id="set-team2-logo" placeholder="e.g. logo2.png" oninput="syncState()" style="width:100%; background:#000; border:none; color:#0f0; font-size:10px;">
                        </div>
                    </div>
                </div>
            </details>

            <div class="actions-row">
                <button class="btn-act btn-end" onclick="endInnings()">End Innings</button>
                <button class="btn-act btn-reset" onclick="resetGame()">Reset</button>
            </div>
        </div>

        <div class="control-column col-players">
            <h3>Players</h3>
            <div class="input-row"><label>Striker</label><input type="text" id="input-bat1" value="OPENER 1" onchange="syncState()"></div>
            <div class="input-row"><label>Non-Str</label><input type="text" id="input-bat2" value="OPENER 2" onchange="syncState()"></div>
            <div class="input-row" style="margin-top:5px; border-top:1px solid #444; padding-top:5px;"><label>Bowler</label><input type="text" id="input-bowler" value="BOWLER" onchange="syncState()"></div>
            <button class="btn-act btn-swap" onclick="swapBatsmen()">Swap Ends ⇄</button>
        </div>

        <div class="control-column col-scoring">
            <h3>Scoring</h3>
            <div class="score-grid" id="scoring-buttons">
                <button class="btn-0" onclick="addScore(0)">0</button>
                <button class="btn-1" onclick="addScore(1)">1</button>
                <button class="btn-2" onclick="addScore(2)">2</button>
                <button class="btn-3" onclick="addScore(3)">3</button>
                <button class="btn-4" onclick="addScore(4)">4</button>
                <button class="btn-6" onclick="addScore(6)">6</button>
                <button class="btn-wd" onclick="addExtra('wd')">WD</button>
                <button class="btn-nb" onclick="addNoBall()">NB</button>
                <button class="btn-w" onclick="addWicket()" style="grid-column: span 3;">OUT</button>
                <button class="btn-fh" onclick="toggleFreeHit()" title="Toggle Free Hit State">FH</button>
            </div>
            
            <details class="styled-details">
                <summary>✎ Manual Score Override</summary>
                <div class="manual-inputs">
                    <div class="manual-group">
                        <label>Runs</label>
                        <input type="number" id="man-runs" title="Total Runs">
                    </div>
                    <div class="manual-group">
                        <label>Wkts</label>
                        <input type="number" id="man-wickets" title="Total Wickets">
                    </div>
                    <div class="manual-group">
                        <label>Ovs</label>
                        <input type="number" id="man-overs" title="Completed Overs">
                    </div>
                    <div class="manual-group">
                        <label>Balls</label>
                        <input type="number" id="man-balls" title="Balls in current over (0-5)">
                    </div>
                    <button class="btn-set-manual" onclick="applyManualScore()">SET</button>
                </div>
            </details>

            <button class="btn-act btn-undo" style="width:100%; margin-top:5px;" onclick="undo()">⤺ Undo Last Ball</button>
            <div id="new-over-container"><button class="btn-next-over" onclick="startNewOver()">Start Next Over</button></div>
        </div>
    </div>

    <script>
        const defaultLogo = "https://cdn-icons-png.flaticon.com/512/16/16480.png";
        
        // ** BROADCAST CHANNEL FOR INSTANT SYNC **
        const bc = new BroadcastChannel('obs_cricket_sync');

        // --- STATE ---
        const initialState = {
            inning: 1, target: 0,
            team1: { name: "", color: "#ffffff", logo: "" }, // Empty logo by default
            team2: { name: "", color: "#ffffff", logo: "" },
            totalRuns: 0, wickets: 0, overs: 0, balls: 0, isOverComplete: false,
            isFreeHit: false, 
            powerplaySpec: "1-6",
            matchOvers: 5,
            lastUpdated: 0, 
            batsmen: [{ name: "OPENER 1", runs: 0, balls: 0 }, { name: "OPENER 2", runs: 0, balls: 0 }],
            strikerIndex: 0,
            bowler: { name: "BOWLER", runs: 0, wickets: 0, ballsBowled: 0 },
            currentOver: [],
            history: [],
            anim: null 
        };

        let matchState = JSON.parse(JSON.stringify(initialState));
        let animTimeout; // Global var for animation timing

        // --- CORE FUNCTIONS ---
        const urlParams = new URLSearchParams(window.location.search);
        const isOverlay = urlParams.get('view') === 'overlay';

        if (isOverlay) {
            document.body.classList.add('overlay-mode');
            
            // 1. BROADCAST CHANNEL LISTENER
            bc.onmessage = (event) => {
                matchState = event.data;
                updateDisplay();
                if(matchState.anim) triggerAnimation(matchState.anim.text, matchState.anim.type);
            };

            // 2. STORAGE EVENT LISTENER
            window.addEventListener('storage', (e) => {
                if (e.key === 'cricket_match_data') {
                    matchState = JSON.parse(e.newValue);
                    updateDisplay();
                    if(matchState.anim) triggerAnimation(matchState.anim.text, matchState.anim.type);
                }
            });

            // 3. POLLING
            setInterval(() => {
                const raw = localStorage.getItem('cricket_match_data');
                if(raw) {
                    const data = JSON.parse(raw);
                    if((data.lastUpdated || 0) > (matchState.lastUpdated || 0)) {
                        matchState = data;
                        updateDisplay();
                    }
                }
            }, 500); 

        } else {
            const saved = localStorage.getItem('cricket_match_data');
            if(saved) {
                matchState = JSON.parse(saved);
                if(!matchState.powerplaySpec) matchState.powerplaySpec = "1-6"; 
                if(!matchState.matchOvers) matchState.matchOvers = 5; 
                restoreInputs();
            }
        }
        updateDisplay();

        // --- NEW: EXTRACT FILENAME FUNCTION ---
        function extractFileName(teamNum) {
            const fileInput = document.getElementById('file-up-' + teamNum);
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                // Update text field with name
                document.getElementById('set-team' + teamNum + '-logo').value = fileName;
                // Trigger sync to save name
                syncState();
            }
        }

        function saveHistory() {
            const snapshot = JSON.parse(JSON.stringify(matchState));
            delete snapshot.history;
            delete snapshot.anim;
            matchState.history.push(snapshot);
            if (matchState.history.length > 30) matchState.history.shift();
        }

        function undo() {
            if (matchState.history && matchState.history.length > 0) {
                const prevHistory = matchState.history;
                matchState = prevHistory.pop();
                matchState.history = prevHistory;
                restoreInputs();
                syncState();
            } else {
                alert("Nothing to undo!");
            }
        }

        function syncState() {
            if(isOverlay) return;
            matchState.team1.name = document.getElementById('set-team1-name').value;
            matchState.team1.color = document.getElementById('set-team1-color').value;
            matchState.team1.logo = document.getElementById('set-team1-logo').value; // Save TEXT

            matchState.team2.name = document.getElementById('set-team2-name').value;
            matchState.team2.color = document.getElementById('set-team2-color').value;
            matchState.team2.logo = document.getElementById('set-team2-logo').value; // Save TEXT

            matchState.batsmen[0].name = document.getElementById('input-bat1').value;
            matchState.batsmen[1].name = document.getElementById('input-bat2').value;
            matchState.bowler.name = document.getElementById('input-bowler').value;
            
            matchState.powerplaySpec = document.getElementById('match-pp').value;
            matchState.matchOvers = parseInt(document.getElementById('match-overs').value) || 5;

            document.getElementById('man-runs').value = matchState.totalRuns;
            document.getElementById('man-wickets').value = matchState.wickets;
            document.getElementById('man-overs').value = matchState.overs;
            document.getElementById('man-balls').value = matchState.balls;

            matchState.lastUpdated = Date.now();

            localStorage.setItem('cricket_match_data', JSON.stringify(matchState));
            bc.postMessage(matchState);
            updateDisplay();
        }

        function restoreInputs() {
            document.getElementById('set-team1-name').value = matchState.team1.name;
            document.getElementById('set-team1-color').value = matchState.team1.color;
            document.getElementById('set-team1-logo').value = matchState.team1.logo || ""; // Restore text

            document.getElementById('set-team2-name').value = matchState.team2.name;
            document.getElementById('set-team2-color').value = matchState.team2.color;
            document.getElementById('set-team2-logo').value = matchState.team2.logo || ""; // Restore text

            document.getElementById('input-bat1').value = matchState.batsmen[0].name;
            document.getElementById('input-bat2').value = matchState.batsmen[1].name;
            document.getElementById('input-bowler').value = matchState.bowler.name;
            
            document.getElementById('match-pp').value = matchState.powerplaySpec || "1-6";
            document.getElementById('match-overs').value = matchState.matchOvers || 5;

            document.getElementById('man-runs').value = matchState.totalRuns;
            document.getElementById('man-wickets').value = matchState.wickets;
            document.getElementById('man-overs').value = matchState.overs;
            document.getElementById('man-balls').value = matchState.balls;
        }

        function applyManualScore() {
            if(!confirm("Manually overwriting the score will affect the total but might desync individual player stats. Continue?")) return;
            saveHistory();
            const r = parseInt(document.getElementById('man-runs').value);
            const w = parseInt(document.getElementById('man-wickets').value);
            const o = parseInt(document.getElementById('man-overs').value);
            const b = parseInt(document.getElementById('man-balls').value);

            if(!isNaN(r)) matchState.totalRuns = r;
            if(!isNaN(w)) matchState.wickets = w;
            if(!isNaN(o)) matchState.overs = o;
            if(!isNaN(b)) matchState.balls = b;

            if (matchState.balls >= 6) {
                matchState.overs += 1;
                matchState.balls = 0;
                matchState.isOverComplete = true;
            } else {
                matchState.isOverComplete = false;
            }
            syncState();
        }

        function pushAnim(text, type) {
            matchState.anim = { text, type };
            matchState.lastUpdated = Date.now();
            localStorage.setItem('cricket_match_data', JSON.stringify(matchState));
            bc.postMessage(matchState); // Trigger anim instantly via channel
            triggerAnimation(text, type); // Trigger local too if needed
            matchState.anim = null;
        }

        // --- NEW: FRAME-BASED ANIMATION TRIGGER ---
        function triggerAnimation(text, type) {
            const overlay = document.getElementById('anim-overlay');
            const scoreboard = document.getElementById('scoreboard-el');
            
            // 1. CLEAR previous animation immediately
            clearTimeout(animTimeout);
            overlay.className = 'event-overlay'; 
            overlay.style.display = 'none'; // Force hide first
            scoreboard.classList.remove('shake');
            overlay.innerText = text;

            // 2. DOUBLE REQUEST ANIMATION FRAME
            // This ensures the browser renders the "hidden" state first, 
            // completely resetting the animation timeline.
            requestAnimationFrame(() => {
                overlay.style.display = 'flex'; // 1. Put it in the DOM (but no anim class yet)
                
                requestAnimationFrame(() => {
                    // 2. NOW add the class. The browser guarantees this happens in the next frame.
                    if (type === 'four') overlay.classList.add('style-four');
                    else if (type === 'six') overlay.classList.add('style-six');
                    else if (type === 'wicket') {
                        overlay.classList.add('style-wicket');
                        scoreboard.classList.add('shake');
                    } 
                    else if (type === 'win') overlay.classList.add('style-win');
                    else {
                        overlay.style.background = '#333';
                        overlay.style.padding = '20px';
                        overlay.classList.add('style-win'); 
                    }
                });
            });

            // 3. Set timer to hide it
            animTimeout = setTimeout(() => { 
                overlay.className = 'event-overlay';
                overlay.style.display = 'none';
                scoreboard.classList.remove('shake');
            }, 3000);
        }

        function isPowerplay() {
            if(!matchState.powerplaySpec) return false;
            let currentOver = matchState.overs + 1;
            let ranges = matchState.powerplaySpec.split(',');
            for(let r of ranges) {
                let parts = r.trim().split('-');
                if(parts.length === 2) {
                    let start = parseInt(parts[0]);
                    let end = parseInt(parts[1]);
                    if(currentOver >= start && currentOver <= end) return true;
                } else if (parts.length === 1) {
                    if(currentOver === parseInt(parts[0])) return true;
                }
            }
            return false;
        }

        function updateDisplay() {
            const sb = document.getElementById('scoreboard-el');
            const matchTitle = document.getElementById('match-teams-display');
            const infoBar = document.getElementById('info-bar');

            let batTeam = matchState.inning === 1 ? matchState.team1 : matchState.team2;
            let bowlTeam = matchState.inning === 1 ? matchState.team2 : matchState.team1;

            matchTitle.innerHTML = `${batTeam.name || ''} <span style="font-size:0.8em;color:#ccc">v</span> ${bowlTeam.name || ''}`;
            
            // LOGO LOGIC: Use File Name if present, else default
            document.getElementById('img-left').src = batTeam.logo ? batTeam.logo : defaultLogo; 
            document.getElementById('img-right').src = bowlTeam.logo ? bowlTeam.logo : defaultLogo;
            
            // sb.style.background = `linear-gradient(to right, ${batTeam.color} 0%, #f0f0f0 30%, #f0f0f0 70%, ${bowlTeam.color} 100%)`;

            document.getElementById('total-runs').innerText = matchState.totalRuns;
            document.getElementById('total-wickets').innerText = matchState.wickets;
            document.getElementById('overs-display').innerText = matchState.overs + "." + matchState.balls;
            
            let totalBalls = (matchState.overs * 6) + matchState.balls;
            document.getElementById('crr-display').innerText = totalBalls > 0 ? (matchState.totalRuns / (totalBalls/6)).toFixed(2) : "0.00";

            if (matchState.isFreeHit) document.getElementById('fh-label').classList.add('visible');
            else document.getElementById('fh-label').classList.remove('visible');

            if (isPowerplay()) document.getElementById('pp-label').classList.add('visible');
            else document.getElementById('pp-label').classList.remove('visible');

            if(matchState.totalRuns > 0 || matchState.inning === 2 || matchState.isFreeHit || isPowerplay()) infoBar.classList.add('visible');
            else infoBar.classList.remove('visible');

            const targetWrapper = document.getElementById('target-wrapper');
            const eqEl = document.getElementById('equation-display');
            const matchOvers = matchState.matchOvers || 5;

            if (matchState.inning === 2) {
                targetWrapper.style.display = 'flex';
                document.getElementById('target-display').innerText = matchState.target;
                let runsNeeded = matchState.target - matchState.totalRuns;
                let ballsRem = (matchOvers * 6) - totalBalls;
                if(runsNeeded <= 0) eqEl.innerText = "TARGET CHASED!";
                else if (ballsRem <= 0) eqEl.innerText = "MATCH ENDED";
                else eqEl.innerText = `NEED ${runsNeeded} OFF ${ballsRem}`;
            } else { targetWrapper.style.display = 'none'; }

            document.getElementById('bat1-name').innerText = matchState.batsmen[0].name;
            document.getElementById('bat1-runs').innerText = matchState.batsmen[0].runs;
            document.getElementById('bat1-balls').innerText = matchState.batsmen[0].balls;
            document.getElementById('bat2-name').innerText = matchState.batsmen[1].name;
            document.getElementById('bat2-runs').innerText = matchState.batsmen[1].runs;
            document.getElementById('bat2-balls').innerText = matchState.batsmen[1].balls;

            if(matchState.strikerIndex === 0) { 
                document.getElementById('bat1-indicator').classList.add('active'); 
                document.getElementById('bat2-indicator').classList.remove('active'); 
            } else { 
                document.getElementById('bat1-indicator').classList.remove('active'); 
                document.getElementById('bat2-indicator').classList.add('active'); 
            }

            document.getElementById('bowler-name').innerText = matchState.bowler.name;
            document.getElementById('bowler-runs').innerText = matchState.bowler.runs;
            document.getElementById('bowler-wickets').innerText = matchState.bowler.wickets;
            document.getElementById('bowler-overs').innerText = Math.floor(matchState.bowler.ballsBowled / 6) + "." + (matchState.bowler.ballsBowled % 6);

            const historyContainer = document.getElementById('ball-history');
            historyContainer.innerHTML = ''; 
            matchState.currentOver.forEach(ball => {
                let div = document.createElement('div');
                div.className = 'ball ' + (ball.type || '');
                if(ball.val == '4') div.classList.add('four');
                if(ball.val == '6') div.classList.add('six');
                if(ball.val == 'W') div.classList.add('wicket');
                div.innerText = ball.val;
                historyContainer.appendChild(div);
            });

            if(!document.getElementById('man-runs').matches(':focus')) document.getElementById('man-runs').value = matchState.totalRuns;
            if(!document.getElementById('man-wickets').matches(':focus')) document.getElementById('man-wickets').value = matchState.wickets;
            if(!document.getElementById('man-overs').matches(':focus')) document.getElementById('man-overs').value = matchState.overs;
            if(!document.getElementById('man-balls').matches(':focus')) document.getElementById('man-balls').value = matchState.balls;

            document.getElementById('scoring-buttons').style.opacity = matchState.isOverComplete ? '0.3' : '1';
            document.getElementById('scoring-buttons').style.pointerEvents = matchState.isOverComplete ? 'none' : 'auto';
            document.getElementById('new-over-container').style.display = matchState.isOverComplete ? 'block' : 'none';
            document.getElementById('over-msg').style.display = matchState.isOverComplete ? 'block' : 'none';
        }

        // --- SCORING ---
        function toggleFreeHit() {
            saveHistory();
            matchState.isFreeHit = !matchState.isFreeHit;
            syncState();
        }

        function addScore(runs) {
            saveHistory();
            matchState.anim = null;
            if(runs === 4) pushAnim("FOUR!", "four");
            if(runs === 6) pushAnim("SIX!", "six");
            matchState.totalRuns += runs;
            matchState.batsmen[matchState.strikerIndex].runs += runs;
            matchState.batsmen[matchState.strikerIndex].balls += 1;
            matchState.bowler.runs += runs;
            matchState.bowler.ballsBowled += 1;
            matchState.currentOver.push({val: runs, type: 'run'});
            let overEnd = handleLegalBall();
            
            // Free Hit Reset Logic
            if(matchState.isFreeHit) {
                matchState.isFreeHit = false; // Reset after legal ball
            }

            if (runs % 2 !== 0) swapBatsmen(false);
            if (overEnd) swapBatsmen(false); 
            if (matchState.inning === 2 && matchState.totalRuns >= matchState.target) pushAnim("WIN!", "win");
            syncState();
        }

        function addWicket() {
            // Free Hit Protection Logic
            if (matchState.isFreeHit) {
                if(!confirm("⚠️ It's a Free Hit! Wickets are invalid unless it's a RUN OUT.\nIs this a Run Out?")) return;
            }

            saveHistory();
            pushAnim("WICKET!", "wicket");
            
            matchState.wickets += 1;
            matchState.bowler.wickets += 1;
            matchState.batsmen[matchState.strikerIndex].balls += 1;
            matchState.bowler.ballsBowled += 1;
            matchState.currentOver.push({val: 'W', type: 'wicket'});
            
            // Reset FH if it was active
            matchState.isFreeHit = false;

            let overEnd = handleLegalBall();
            
            syncState(); 

            setTimeout(() => {
                let n = prompt("New batsman name:", "Next Bat");
                matchState.anim = null; 
                matchState.batsmen[matchState.strikerIndex] = { name: n || "Next Bat", runs: 0, balls: 0 };
                document.getElementById(matchState.strikerIndex === 0 ? 'input-bat1' : 'input-bat2').value = n || "Next Bat";
                if (overEnd) swapBatsmen(false);
                syncState();
            }, 100);
        }

        function addExtra(type) {
            saveHistory();
            if(type === 'wd') {
                let extras = prompt("Wide conceded! Total runs for this ball? (1 = normal wide, 2 = wide+1 run, 5 = wide boundary)", "1");
                let total = parseInt(extras) || 1;
                matchState.totalRuns += total; 
                matchState.bowler.runs += total;
                matchState.currentOver.push({val: (total > 1 ? 'WD+'+(total-1) : 'WD'), type: 'wide'});
                // NOTE: Free Hit status does NOT change on a Wide.
            }
            syncState();
        }

        function addNoBall() {
            saveHistory();
            let r = parseInt(prompt("Runs off bat?", "0")) || 0;
            matchState.totalRuns += (1 + r); matchState.bowler.runs += (1 + r);
            if(r > 0) matchState.batsmen[matchState.strikerIndex].runs += r;
            matchState.currentOver.push({val: 'NB' + (r>0?'+'+r:''), type: 'nb'});
            if(r % 2 !== 0) swapBatsmen(false);
            
            // ACTIVATE FREE HIT AUTOMATICALLY
            matchState.isFreeHit = true;

            syncState();
        }

        function handleLegalBall() {
            matchState.balls++;
            if (matchState.balls >= 6) { matchState.overs++; matchState.balls = 0; matchState.isOverComplete = true; return true; }
            return false;
        }

        function swapBatsmen(sync = true) {
            matchState.strikerIndex = matchState.strikerIndex === 0 ? 1 : 0;
            if(sync) syncState();
        }

        function startNewOver() {
            let n = prompt("Next Bowler:", "Bowler");
            matchState.isOverComplete = false; matchState.currentOver = [];
            matchState.bowler = { name: n || "Bowler", runs: 0, wickets: 0, ballsBowled: 0 };
            document.getElementById('input-bowler').value = n || "Bowler";
            syncState();
        }

        function endInnings() {
            if(confirm("End Innings?")) {
                matchState.target = matchState.totalRuns + 1;
                matchState.inning = 2;
                matchState.totalRuns = 0; matchState.wickets = 0; matchState.overs = 0; matchState.balls = 0;
                matchState.isOverComplete = false; matchState.currentOver = [];
                matchState.batsmen = [{name: "CHASER 1", runs:0, balls:0}, {name: "CHASER 2", runs:0, balls:0}];
                matchState.bowler = {name: "DEFENDER", runs:0, wickets:0, ballsBowled:0};
                matchState.history = [];
                matchState.isFreeHit = false; // Reset FH
                restoreInputs();
                syncState();
            }
        }

        function resetGame() {
            if(confirm("Reset all?")) {
                matchState = JSON.parse(JSON.stringify(initialState));
                restoreInputs();
                syncState();
            }
        }
    </script>
</body>
</html>